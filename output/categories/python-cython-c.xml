<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="../assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>@FPSD (python cython c)</title><link>https://francesco.pischedda.info/</link><description></description><atom:link href="https://francesco.pischedda.info/categories/python-cython-c.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><lastBuildDate>Fri, 06 Jan 2017 18:48:49 GMT</lastBuildDate><generator>https://getnikola.com/</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Cython and C pointers</title><link>https://francesco.pischedda.info/posts/cython-and-c-pointers/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div&gt;&lt;p&gt;&lt;a class="reference external" href="http://www.cython.org/"&gt;Cython&lt;/a&gt; is a powerful tool that can speed up your &lt;a class="reference external" href="https://www.python.org/"&gt;Python&lt;/a&gt; code or can help you
to quickly create an extension module for a library that has c bindings.&lt;/p&gt;
&lt;p&gt;This post is not a cython tutorial but its about a problem I have encountered
during the development of a wrapper to Wakaama LWM2M library; if you
want to learn more about &lt;a class="reference external" href="http://www.cython.org/"&gt;Cython&lt;/a&gt; please refer to its &lt;a class="reference external" href="https://cython.readthedocs.io/en/latest/"&gt;documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;During the development of said wrapper I have had a nasty strange bug affecting
my code, at some point some object referenced by a pointer kept at the C library
side seemed to change its value! For example think about this situation:
- you pass an object to a certain c function
- the object's pointer is stored internally by the c library
- you retrieve the object from the c library but its content its not the same...it's not even an instance of the same class!&lt;/p&gt;
&lt;p&gt;To reproduce this behaviour please have a look at overwrite.py in my test &lt;a class="reference external" href="https://github.com/fpischedda/cython-post"&gt;project&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;At first I've been thinking about memory corruption caused by the C library code;
this wrong assumption costed me at least two days of messing with gdb (that
saved my life in another memory related bug) that have not given any useful
insight.&lt;/p&gt;
&lt;p&gt;I don't remember how I've spotted this problem but probably I should have tryed
everything until somwthing pointed me to the right direction.&lt;/p&gt;
&lt;p&gt;What seems to happen here is something like this:
- create an object and assign it to a variable A
- store its pointer in the C library
- get back the pointer of the object; it will be the same object as referenced by A
- assign a new object to A
- create an object assign it to a variable B
- get back the pointer of the object; it will NOT be the same object as&lt;/p&gt;
&lt;div class="system-message"&gt;
&lt;p class="system-message-title"&gt;System Message: ERROR/3 (&lt;tt class="docutils"&gt;&amp;lt;string&amp;gt;&lt;/tt&gt;, line 32)&lt;/p&gt;
Unexpected indentation.&lt;/div&gt;
&lt;blockquote&gt;
referenced by A but it will be the one referenced by B&lt;/blockquote&gt;
&lt;p&gt;When the variable A is referencing the new object the old one is not referenced
by anyone in the python world and its memory will became available to store the
new object assigned to B and the pointer in the C world is now pointing to what
is referenced by B.&lt;/p&gt;
&lt;p&gt;It may seems obvious but when it happened to me it was inside a callback
originating in the C code and being handled by a function defined by in the
cython context.&lt;/p&gt;
&lt;p&gt;The lesson learned here is: when working with two different languages together
nothing is naive especially when you are wrapping some code that you don't
really know and that can bite your ass as soon as you think "what can go wrong?"&lt;/p&gt;&lt;/div&gt;</description><category>python cython c</category><guid>https://francesco.pischedda.info/posts/cython-and-c-pointers/</guid><pubDate>Fri, 06 Jan 2017 15:43:40 GMT</pubDate></item></channel></rss>