<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="assets/xml/rss.xsl" media="all"?><rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>@FPSD</title><link>https://francesco.pischedda.info/</link><description>random.choice(['programming', 'gaming', 'stuff'])</description><atom:link href="https://francesco.pischedda.info/rss.xml" rel="self" type="application/rss+xml"></atom:link><language>en</language><lastBuildDate>Wed, 09 Sep 2020 19:09:26 GMT</lastBuildDate><generator>Nikola (getnikola.com)</generator><docs>http://blogs.law.harvard.edu/tech/rss</docs><item><title>Exploring Datascript with a small application</title><link>https://francesco.pischedda.info/posts/exploring-datascript-with-a-small-application/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div class="section" id="overview"&gt;
&lt;h2&gt;Overview&lt;/h2&gt;
&lt;p&gt;In a previous post I have briefly described how using ClojureScript, Rum and
Datascript helped me to explore a new way to prototype software starting by
investigating how the user is going to interact with it.&lt;/p&gt;
&lt;p&gt;People, instead, showed more interest on Datascript (go figure :) ) so in this
post I am going to write a small application to explore how to use Datascript
and Datalog without digging too much into the nitty gritty details of both
because, I think, there are better resources out there. (See &lt;a class="reference external" href="https://francesco.pischedda.info/posts/exploring-datascript-with-a-small-application/Links"&gt;Links section&lt;/a&gt;.)&lt;/p&gt;
&lt;div class="section" id="the-application"&gt;
&lt;h3&gt;The application&lt;/h3&gt;
&lt;p&gt;Instead of writing the usual TODO app, I would like to provide a way for users
to give feedback to my blog posts. Usually this is why you add a comment area
to your website but it would be nice if readers could write their feedback
for each section and not just the whole post.&lt;/p&gt;
&lt;p&gt;For now I want to focus on the frontend part of it, to get a feel of how it
could work in the hands of the users. If it proves to be usable I can think of
a way to store the feedback to a durable storage, eventually add access control,
eventually an admin interface etc etc.&lt;/p&gt;
&lt;p&gt;To keep things super simple I will target the structure of my blog posts which
is more or less like this:&lt;/p&gt;
&lt;pre class="code html"&gt;&lt;a name="rest_code_63ff1bd41d7b410087dfc3890fa8e43e-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'body'&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;a name="rest_code_63ff1bd41d7b410087dfc3890fa8e43e-2"&gt;&lt;/a&gt;  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'section'&lt;/span&gt; &lt;span class="na"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'section-title'&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;a name="rest_code_63ff1bd41d7b410087dfc3890fa8e43e-3"&gt;&lt;/a&gt;    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;Section title&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;a name="rest_code_63ff1bd41d7b410087dfc3890fa8e43e-4"&gt;&lt;/a&gt;    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;p&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;Text&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;p&lt;/span&gt;&lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
&lt;a name="rest_code_63ff1bd41d7b410087dfc3890fa8e43e-5"&gt;&lt;/a&gt;  &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;a name="rest_code_63ff1bd41d7b410087dfc3890fa8e43e-6"&gt;&lt;/a&gt;&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;The div with class body is the main container; inside there are N section div
elements, each with an id which is the slugified title of the section, an h2
element with the title of the section and finally the content.&lt;/p&gt;
&lt;p&gt;At start the application will fetch all post's sections, will store their id and
title in the database, and will attach a react component to them which will:
- provide a "Write your feedback" button which will toggle the feedback area composed by
- a form to write new comments
- a list of old comments with buttons to reply to or to delete them&lt;/p&gt;
&lt;p&gt;The sources of the application are available &lt;a class="reference external" href="https://github.com/fpischedda/blog-feedback-app"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I suggest to try the full application to get a feel of how it looks and works;
to run it please follow the instructions in the &lt;a class="reference external" href="https://github.com/fpischedda/blog-feedback-app/blob/master/README.md"&gt;README.md&lt;/a&gt; of the project.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="stack-for-the-prototype"&gt;
&lt;h3&gt;Stack for the prototype&lt;/h3&gt;
&lt;p&gt;To build this application I have chosen to use my (currently) preferred
prototyping stack which is composed by:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;ClojureScript: the language&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Figwheel.main: build system and live code update&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Rum: React wrapper library&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Datascript: in memory Datalog database&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For me, this work pretty well and I feel quite productive with it; the main
benefit is the fast feedback loop provided by figwheel, the easy of use of Rum,
a powerful, easy to use, database where to store the application state and last
but not least a REPL where I can quickly fiddle with every bit of the
application.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="data-model"&gt;
&lt;h3&gt;Data model&lt;/h3&gt;
&lt;p&gt;For this simple application there are only two entities that we are going to
store in the database: section and comment; lets define a data model that will
hold the application state:&lt;/p&gt;
&lt;p&gt;section&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;id: string, HTML id of the section&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;name: string, name/title of the section as extracted from the HTML&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;feedback/comment&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;id: uuid&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;author: string, author of the comment&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;text: string, the content itself&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;created-at: string, ISO format of the time of the creation&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;parent: optional, ref to parent comment&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The data model can be described with the following schema:&lt;/p&gt;
&lt;pre class="code clojure"&gt;&lt;a name="rest_code_53d9eb7156124b2085a135cb3b0a15af-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;def &lt;/span&gt;&lt;span class="nv"&gt;schema&lt;/span&gt;
&lt;a name="rest_code_53d9eb7156124b2085a135cb3b0a15af-2"&gt;&lt;/a&gt;  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:section/id&lt;/span&gt;      &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:db/unique&lt;/span&gt; &lt;span class="ss"&gt;:db.unique/identity&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;a name="rest_code_53d9eb7156124b2085a135cb3b0a15af-3"&gt;&lt;/a&gt;   &lt;span class="ss"&gt;:comment/id&lt;/span&gt;      &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:db/unique&lt;/span&gt; &lt;span class="ss"&gt;:db.unique/identity&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;a name="rest_code_53d9eb7156124b2085a135cb3b0a15af-4"&gt;&lt;/a&gt;   &lt;span class="ss"&gt;:comment/section&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:db/valueType&lt;/span&gt; &lt;span class="ss"&gt;:db.type/ref&lt;/span&gt;
&lt;a name="rest_code_53d9eb7156124b2085a135cb3b0a15af-5"&gt;&lt;/a&gt;                     &lt;span class="ss"&gt;:db/cardinality&lt;/span&gt; &lt;span class="ss"&gt;:db.cardinality/one&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;a name="rest_code_53d9eb7156124b2085a135cb3b0a15af-6"&gt;&lt;/a&gt;   &lt;span class="ss"&gt;:comment/parent&lt;/span&gt;  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="ss"&gt;:db/valueType&lt;/span&gt; &lt;span class="ss"&gt;:db.type/ref&lt;/span&gt;
&lt;a name="rest_code_53d9eb7156124b2085a135cb3b0a15af-7"&gt;&lt;/a&gt;                     &lt;span class="ss"&gt;:db/cardinality&lt;/span&gt; &lt;span class="ss"&gt;:db.cardinality/one&lt;/span&gt;&lt;span class="p"&gt;}})&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;As you may have noticed, not all attributes of the entities are in the schema,
if fact it is sufficient to describe attributes with special meaning like ids
or references.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="data-layer"&gt;
&lt;h3&gt;Data layer&lt;/h3&gt;
&lt;p&gt;Usually I like to have a separate namespace for the data and presentation
layers, even for applications as simple as this one.
Lets have a look at the &lt;a class="reference external" href="https://github.com/fpischedda/blog-feedback-app/blob/master/src/cljs/app/db.cljs"&gt;app.db namespace&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;After defining the schema, the db gets created with the following form:&lt;/p&gt;
&lt;pre class="code clojure"&gt;&lt;a name="rest_code_c844a549a92141eb9c8c5187bc6f3fa7-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;def &lt;/span&gt;&lt;span class="nv"&gt;db&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;d/create-conn&lt;/span&gt; &lt;span class="nv"&gt;schema&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;It is common to use &lt;cite&gt;defonce&lt;/cite&gt; when defining app state to not reset it after
a code reload but, in this case, I prefer to &lt;cite&gt;def&lt;/cite&gt; because, when experimenting,
it is quite useful to be able to change the schema and you may want to use the
newest one in your database.&lt;/p&gt;
&lt;p&gt;Another important tool for experimentation is to quickly populate the database
with mock data; I find it very useful when it comes the time to work on the UI
or when I need to test queries and transactions.&lt;/p&gt;
&lt;p&gt;Here is an example query and the result when some data is in the database:&lt;/p&gt;
&lt;pre class="code clojure"&gt;&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defn &lt;/span&gt;&lt;span class="nv"&gt;all-sections&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;db&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-2"&gt;&lt;/a&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;d/q&lt;/span&gt; &lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="ss"&gt;:find&lt;/span&gt; &lt;span class="nv"&gt;?id&lt;/span&gt; &lt;span class="nv"&gt;?name&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-3"&gt;&lt;/a&gt;         &lt;span class="ss"&gt;:where&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-4"&gt;&lt;/a&gt;         &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;?s&lt;/span&gt; &lt;span class="ss"&gt;:section/id&lt;/span&gt; &lt;span class="nv"&gt;?id&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-5"&gt;&lt;/a&gt;         &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;?s&lt;/span&gt; &lt;span class="ss"&gt;:section/name&lt;/span&gt; &lt;span class="nv"&gt;?name&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-6"&gt;&lt;/a&gt;         &lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-7"&gt;&lt;/a&gt;    &lt;span class="nv"&gt;db&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-8"&gt;&lt;/a&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-9"&gt;&lt;/a&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;comment&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-10"&gt;&lt;/a&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;all-sections&lt;/span&gt; &lt;span class="o"&gt;@&lt;/span&gt;&lt;span class="nv"&gt;db&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;;; =&amp;gt; #{["overview" "Overview"] ["application-design" "Application design"]}&lt;/span&gt;
&lt;a name="rest_code_7e241c064d2a4a9f986036f87a7f35ee-11"&gt;&lt;/a&gt;  &lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;Digging a bit more in to the db namespace, we can find an example of how using
aggregates looks like in the section-comments-count function, here is the code:&lt;/p&gt;
&lt;pre class="code clojure"&gt;&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defn &lt;/span&gt;&lt;span class="nv"&gt;section-comments-count&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-2"&gt;&lt;/a&gt;  &lt;span class="s"&gt;"If the query cannot find any entity that matches then it cannot reasonably&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-3"&gt;&lt;/a&gt;&lt;span class="s"&gt;   count anything and it will return nil; with the use of `or` we can handle&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-4"&gt;&lt;/a&gt;&lt;span class="s"&gt;   this case and return 0."&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-5"&gt;&lt;/a&gt;  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;db&lt;/span&gt; &lt;span class="nv"&gt;section-id&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-6"&gt;&lt;/a&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;or&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-7"&gt;&lt;/a&gt;    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;d/q&lt;/span&gt; &lt;span class="o"&gt;'&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="ss"&gt;:find&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;count &lt;/span&gt;&lt;span class="nv"&gt;?c&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nv"&gt;.&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-8"&gt;&lt;/a&gt;             &lt;span class="ss"&gt;:in&lt;/span&gt; &lt;span class="nv"&gt;$&lt;/span&gt; &lt;span class="nv"&gt;?section-id&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-9"&gt;&lt;/a&gt;             &lt;span class="ss"&gt;:where&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-10"&gt;&lt;/a&gt;             &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;?s&lt;/span&gt; &lt;span class="ss"&gt;:section/id&lt;/span&gt; &lt;span class="nv"&gt;?section-id&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-11"&gt;&lt;/a&gt;             &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;?c&lt;/span&gt; &lt;span class="ss"&gt;:comment/section&lt;/span&gt; &lt;span class="nv"&gt;?s&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-12"&gt;&lt;/a&gt;             &lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-13"&gt;&lt;/a&gt;        &lt;span class="nv"&gt;db&lt;/span&gt; &lt;span class="nv"&gt;section-id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a name="rest_code_7bfa717e85ff463b9376978eaeb3af51-14"&gt;&lt;/a&gt;    &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;As stated in the docstring, when there are no matching entities, the query will
return &lt;cite&gt;nil&lt;/cite&gt;, for this reason I use an &lt;cite&gt;or&lt;/cite&gt; to return the correct value (zero).&lt;/p&gt;
&lt;p&gt;Also, please note the &lt;cite&gt;dot&lt;/cite&gt; after the call to &lt;cite&gt;count&lt;/cite&gt;, this signals that we
want a scalar value back instead of a set with one element containing the count.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="building-the-ui"&gt;
&lt;h3&gt;Building the UI&lt;/h3&gt;
&lt;p&gt;After a quick tour of the data layer is now the turn of the UI part which
can be found in the &lt;a class="reference external" href="https://github.com/fpischedda/blog-feedback-app/blob/master/src/cljs/app/core.cljs"&gt;app.core namespace&lt;/a&gt;.
This namespace make more sense if read bottom to top while the db namespace is
better read top to bottom.&lt;/p&gt;
&lt;p&gt;At start, the application looks for all section elements, stores the section id
and name of the section in the detabase and attaches a feedback component to it.
This can be seen it the following code fragment:&lt;/p&gt;
&lt;pre class="code clojure"&gt;&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kd"&gt;defn &lt;/span&gt;&lt;span class="nv"&gt;init-app&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-2"&gt;&lt;/a&gt;  &lt;span class="s"&gt;"fetches all elements with a section class, parse all sections,&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-3"&gt;&lt;/a&gt;&lt;span class="s"&gt;   remove prevoius feedback related elements (useful when reloading script)&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-4"&gt;&lt;/a&gt;&lt;span class="s"&gt;   and add them to the db, finally attach a `feedback` button to all&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-5"&gt;&lt;/a&gt;&lt;span class="s"&gt;   sections' container div"&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-6"&gt;&lt;/a&gt;  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;db&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-7"&gt;&lt;/a&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;sections&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;dom/getElementsByClass&lt;/span&gt; &lt;span class="s"&gt;"section"&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-8"&gt;&lt;/a&gt;    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;doseq &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;section&lt;/span&gt; &lt;span class="nv"&gt;sections&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-9"&gt;&lt;/a&gt;      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;attach-feedback-component-to-section&lt;/span&gt; &lt;span class="nv"&gt;section&lt;/span&gt; &lt;span class="nv"&gt;db&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a name="rest_code_aa279b20f3ea4f0b95c4f93f4f00bba3-10"&gt;&lt;/a&gt;    &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;start-listener!&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt; &lt;span class="c1"&gt;;; start-listener will be addressed later&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;Each component will receive the database instance and will react to changes;
this is possible because a database is basically an atom so using rum/reactive
mixin works out of the box, here is the main component's code:&lt;/p&gt;
&lt;pre class="code clojure"&gt;&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-1"&gt;&lt;/a&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rum/defc&lt;/span&gt; &lt;span class="nv"&gt;feedback-component&lt;/span&gt; &lt;span class="nb"&gt;&amp;lt; &lt;/span&gt;&lt;span class="nv"&gt;rum/reactive&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-2"&gt;&lt;/a&gt;  &lt;span class="s"&gt;"feedback area is composed by an input text for the author,&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-3"&gt;&lt;/a&gt;&lt;span class="s"&gt;   a textarea for the message and a div containing all previous messages&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-4"&gt;&lt;/a&gt;&lt;span class="s"&gt;   for the current section identified by `section-id`"&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-5"&gt;&lt;/a&gt;  &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;section-id&lt;/span&gt; &lt;span class="nv"&gt;db&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-6"&gt;&lt;/a&gt;  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;let &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;db&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rum/react&lt;/span&gt; &lt;span class="nv"&gt;db&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;;; &amp;lt;- the component will react to changes of the db&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-7"&gt;&lt;/a&gt;        &lt;span class="nv"&gt;area-id&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;str &lt;/span&gt;&lt;span class="s"&gt;"feedback-area-"&lt;/span&gt; &lt;span class="nv"&gt;section-id&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-8"&gt;&lt;/a&gt;        &lt;span class="nv"&gt;comments&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;sorted&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;db/section-comments&lt;/span&gt; &lt;span class="nv"&gt;db&lt;/span&gt; &lt;span class="nv"&gt;section-id&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-9"&gt;&lt;/a&gt;        &lt;span class="nv"&gt;comment-count&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;db/section-comments-count&lt;/span&gt; &lt;span class="nv"&gt;db&lt;/span&gt; &lt;span class="nv"&gt;section-id&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-10"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;;; view code omitted for brevity&lt;/span&gt;
&lt;a name="rest_code_9a200f3d813942f9b2b0317f956f412e-11"&gt;&lt;/a&gt;    &lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;The following binding does most of the magic:&lt;/p&gt;
&lt;pre class="code clojure"&gt;&lt;a name="rest_code_1ac65d2b97624410a60c05c911adc742-1"&gt;&lt;/a&gt;&lt;span class="nv"&gt;db&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;rum/react&lt;/span&gt; &lt;span class="nv"&gt;db&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;Simplifying, it subscribes to the db atom and derefs it, like we would do
with @db or (deref db); a this point it will be possible to use the returned
reference in queries like:&lt;/p&gt;
&lt;pre class="code clojure"&gt;&lt;a name="rest_code_6175c9aa11694cd787d0d207c462bf40-1"&gt;&lt;/a&gt;&lt;span class="nv"&gt;comments&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;sorted&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nf"&gt;db/section-comments&lt;/span&gt; &lt;span class="nv"&gt;db&lt;/span&gt; &lt;span class="nv"&gt;section-id&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="closing-words"&gt;
&lt;h3&gt;Closing words&lt;/h3&gt;
&lt;p&gt;The rest of the application details are out of scope and it should be trivial
to figure them out by reading the documentation of libraries used to build the
application.&lt;/p&gt;
&lt;p&gt;I hope that this quick tour of a simple application may have given you some
pointers to start to work with Datascript and eventually Rum.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="id1"&gt;
&lt;h3&gt;Links section&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="http://www.learndatalogtoday.org/"&gt;Learn Datalog today&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://tonsky.me/blog/datascript-internals/"&gt;A shallow dive into DataScript internals&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;a class="reference external" href="https://www.youtube.com/watch?v=oo-7mN9WXTw&amp;amp;amp;feature=youtu.be"&gt;DOMAIN MODELING WITH DATALOG by Norbert Wojtowicz&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;style&gt;
  .invisible {
    display: none;
  }
&lt;/style&gt;
&lt;script type="text/javascript" src="https://francesco.pischedda.info/js/app.js"&gt;&lt;/script&gt;&lt;/div&gt;
&lt;/div&gt;</description><category>clojure clojurescript rum datascript datalog</category><guid>https://francesco.pischedda.info/posts/exploring-datascript-with-a-small-application/</guid><pubDate>Wed, 02 Sep 2020 09:43:16 GMT</pubDate></item><item><title>My new approach to software prototyping and the stack that makes it possible</title><link>https://francesco.pischedda.info/posts/my-new-approach-to-software-prototyping-and-the-stack-that-makes-it-possible/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div class="section" id="foreword"&gt;
&lt;h2&gt;Foreword&lt;/h2&gt;
&lt;p&gt;In this blog post I am going to illustrate how, during the development of a
pet project, I have changed the way I approach software development and
prototyping, going from "backend first" to "frontend first, backend eventually".
I will also mention the tools that make it possible and even enjoyable for a non
frontend developer.&lt;/p&gt;
&lt;div class="section" id="background"&gt;
&lt;h3&gt;Background&lt;/h3&gt;
&lt;p&gt;At $work I have always spent most of my time in the backend and infrastructure
side of things but sometimes, especially when working on side projects, I have
to go "full stack" and take care of frontend tasks, even if I kind of suck at
it.
For this reason I am always inclined to start with some sort of backend code,
starting with a data model, core business logic and a REST API to (eventually)
build a frontend on top of it...which most of the times means I will lose
interest/momentum and the project dies.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="at-some-point-something-clicked"&gt;
&lt;h3&gt;At some point something clicked&lt;/h3&gt;
&lt;p&gt;One day (probably a lazy Sunday) I had an idea: I want an incredibly stupid
way to collect random thoughts, links or any kind of text blob, I want to own
it, it must live on my VPS and I have to finish it today!
This time thoughts decided to follow a different path:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;how important what I am going to write here is? can I afford to lose data?&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;what if I don't need to store anything in a durable storage?&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;ok, aim for least amount of features and see later if I need more&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The outcome is a service that will keep all data in volatile memory, losing it
at each restart and this is perfectly fine for what I needed at that time!
I think this small tool planted the seed for what, I think, will be be my
preferred method for future projects.&lt;/p&gt;
&lt;p&gt;What has been so different with development of this tool is that I have tried
and (more or less succeeded) to address the problem at hand without much
ceremony, and it served its purpose quite well.
At some point I've started to add more features "just because" but, at the end
of the day, the core remained the same and now I even want to remove these new
features because they are not adding value but are, effectively, distracting.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="next-project"&gt;
&lt;h3&gt;Next project&lt;/h3&gt;
&lt;p&gt;Fast forward few months, I am again thinking about a new project.
My girlfriend needed/wanted a tool to make it easy to share a watermarked
version of her drawings, even better if the shared link required a password to
access the image.&lt;/p&gt;
&lt;p&gt;Compared to the previous project, this one is slightly more complex, especially
the user facing part, but I am confident that if I address the most basic
requirements first, I should be able to give her a rough beta in few hours.
Here are the features I have decided to include in the "MVP":&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;user can upload a file&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;user can chose a watermark size&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;user can eventually chose a password to protect the image&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;once the user clicks "Upload", the system applies the watermark and&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;render a page with the list of uploaded/watermarked files, each with a link to it&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So far so good, the tool is there, ugly but working. What if we open this
tool to other people? WOW! We can make our own product! Lets do it!&lt;/p&gt;
&lt;p&gt;Armed with great energy I have started working on the new version but this time
I have started building a full featured backend even if, at this point,
is not 100% clear how a user is going to interact with it, how valuable it
could be and all the usual unknowns.
So why I am insisting with the old approach when it showed, multiple times, it
is quite ineffective? I guess it is a matter of habits (because I don't want
to call it stupidity).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="a-new-approach"&gt;
&lt;h3&gt;A new approach&lt;/h3&gt;
&lt;p&gt;I often fail to make progress on my projects when it comes the turn of the
frontend code, after having written most of the backend, maybe this time I
can try the other way around!
Common sense suggests to create mocks of the interface using tools like
&lt;a class="reference external" href="https://balsamiq.com/wireframes"&gt;Balsamiq&lt;/a&gt;, &lt;a class="reference external" href="https://moqups.com/"&gt;Moqups&lt;/a&gt; and so on but, for some reasons I am totally unable to
use those kind of tools plus I would like to have a taste of how to UI feels
in the hands a user...what should I do now?&lt;/p&gt;
&lt;p&gt;Recently I have started experimenting with &lt;a class="reference external" href="https://www.clojurescript.org"&gt;ClojureScript&lt;/a&gt; and &lt;a class="reference external" href="https://github.com/tonsky/rum"&gt;Rum&lt;/a&gt; (a library
that wraps React) and so far I feel quite productive with it, why should I not
use these tools to write the mock? The plan now looks like this:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;quickly build an ugly but functional UI&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;mock the app state/data to reflect what I need in the UI&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;understand what feels wrong, get feedback from other people&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;plan next iteration&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;repeat until happy&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Essential to this approach is the quick feedback loop you can get by using
ClojureScript + Rum (or any other React wrapper like &lt;a class="reference external" href="https://reagent-project.github.io/"&gt;Reagent&lt;/a&gt;), immutable
persistent data structures and a REPL; I "suspect" that, if we exclude the
REPL, a similar setup can be achieved with other stacks but I am quite happy
with the tools I have chosen.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="how-has-it-been-so-far"&gt;
&lt;h3&gt;How has it been so far?&lt;/h3&gt;
&lt;p&gt;I am not a frontend developer and every time I try to create some sort of UI
I am pretty sure I will fail, lose interest and put the project on hold but,
this time, it has been quite different.
Being able to iterate quickly and having a fast feedback loop, helped me a lot
to proceed at "great speed" and not losing focus.
Each time I wanted to add a new feature or change how a component had to work,
the process has been pretty straightforward:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;create a new branch&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;try out the new idea by small, even tiny iterations with live feedback&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;adjust the data model as needed&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;repeat&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;if happy merge to master otherwise scrap everything and forget&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="managing-the-app-state"&gt;
&lt;h3&gt;Managing the app state&lt;/h3&gt;
&lt;p&gt;One of the points that I would like to spend so time on is the app state.
Even if keeping all the state in one big map is quite handy and flexible,
at some point, it becomes harder and harder to maintain, especially in the
case where there are many ( &amp;gt; 4 or 5) entity types with cross references and
the size of the data gets bigger and bigger; it can still be done but the
state management code starts to get bigger and harder to maintain compared to
the UI code; for my case, the UI code had to know too much about the data model
itself impacting the separation of concerns and this was driving away the focus
on the main goal which is to explore the space of possibilities for the UI I
want to build.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="introducing-datascript-into-my-tool-set"&gt;
&lt;h3&gt;Introducing Datascript into my tool-set&lt;/h3&gt;
&lt;p&gt;With the growing pain of state management I have decided to invest a little bit
of time to find out which solutions are already available in this space and
fortunately I have stepped into &lt;a class="reference external" href="https://github.com/tonsky/datascript"&gt;Datascript&lt;/a&gt;, an in memory database developed by
the same person who gave us Rum :)
This database has all the features I need plus some more; I am sure that I am
still missing some handy features but so far I have been able to:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;build a consistent data store&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;which supports cross references between entities&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;which I can easily query (using Datalog)&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;with support to joins&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Datalog"&gt;Datalog&lt;/a&gt; itself is quite simple even if a bit "alien" until you know how to
use it; instead of writing about it here I prefer to give a link to the best
learning material I have found &lt;a class="reference external" href="http://www.learndatalogtoday.org/"&gt;http://www.learndatalogtoday.org/&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Armed with Datascript (for the data store) and Datalog (for the queries) the
UI code can now interact with the app state without knowing much about it!
This is a great relief because now I can focus again on building a UI for my
project and spend the right amount of time (&amp;lt; 5%) on the data store.&lt;/p&gt;
&lt;p&gt;Another good point of this approach is that, when the backend will be ready,
it will be a matter of translating what I will get out of its APIs to the
UI's internal data store and everything will continue to work as expected.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="summary"&gt;
&lt;h3&gt;Summary&lt;/h3&gt;
&lt;p&gt;The goal of this post was to write down my current approach to software
development with the hope to start a discussion with other developers which
may be interested to explore and talk about novel methodologies which have
worked great for them.
If by reading this blob of text you are now also curious about ClojureScript
and its ecosystem, I am even more happy!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="links"&gt;
&lt;h3&gt;Links&lt;/h3&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;ClojureScript: &lt;a class="reference external" href="https://clojurescript.org/"&gt;https://clojurescript.org/&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Rum: &lt;a class="reference external" href="https://github.com/tonsky/rum"&gt;https://github.com/tonsky/rum&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;DataScript: &lt;a class="reference external" href="https://github.com/tonsky/datascript"&gt;https://github.com/tonsky/datascript&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Datalog: &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Datalog"&gt;https://en.wikipedia.org/wiki/Datalog&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Datalog course: &lt;a class="reference external" href="http://www.learndatalogtoday.org/"&gt;http://www.learndatalogtoday.org/&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Reagent: &lt;a class="reference external" href="https://reagent-project.github.io/"&gt;https://reagent-project.github.io/&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Balsamiq: &lt;a class="reference external" href="https://balsamiq.com/wireframes"&gt;https://balsamiq.com/wireframes&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Moqups: &lt;a class="reference external" href="https://moqups.com/"&gt;https://moqups.com/&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;</description><category>prototyping clojurescript rum react datascript frontend</category><guid>https://francesco.pischedda.info/posts/my-new-approach-to-software-prototyping-and-the-stack-that-makes-it-possible/</guid><pubDate>Sat, 01 Aug 2020 08:08:14 GMT</pubDate></item><item><title>Routing Celery task for simple prioritization</title><link>https://francesco.pischedda.info/posts/routing-celery-task-for-simple-prioritization/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div class="section" id="problem"&gt;
&lt;h2&gt;Problem&lt;/h2&gt;
&lt;p&gt;Like most businesses, where I &lt;a class="reference external" href="https://www.vimcar.com"&gt;work&lt;/a&gt; we need to send lots of notifications to our
users, mainly emails and push notifications; the setup is quite simple:&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;a service accepts requests to send notifications to users&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;the notification service prepare the message and put it in a queue&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;a pool of workers fetches messages from the queue and perform the actual delivery&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;This works reasonably well and we can scale the service increasing the
instances of the notification service and the delivery workers.&lt;/p&gt;
&lt;p&gt;This setup is used also when a user requests an export of her/his historical
data; since this process can take a while, a background job fetches the data,
generates a pdf and sends it via email using the notifications service.
At the same time we generate hundreds of thousands of notifications, usually in
the morning, and this fill up the notifiation queue so if a user requests an
export during this time frame its email will have to wait a lot before it can
be processed.&lt;/p&gt;
&lt;div class="section" id="solution"&gt;
&lt;h3&gt;Solution&lt;/h3&gt;
&lt;dl class="simple"&gt;
&lt;dt&gt;We have evaluated a couple of solutions:&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;per message priority&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;dedicated low priority queue for high volume automaticly generated
notifications using task routing&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;The first solution is a generic one but as far as we have seen it is not easy
to have the guarantie that a high priority message will be delivered in our
desired time frame and we opted for the second solution because we don't need
a fine grained prioritization system (maybe in the future) but just a way to
continue to deliver user generated notifications when we are sending our
automated high volume notifications during the morning.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="implementation"&gt;
&lt;h3&gt;Implementation&lt;/h3&gt;
&lt;dl class="simple"&gt;
&lt;dt&gt;Our stack is based on &lt;a class="reference external" href="http://www.celeryproject.org/"&gt;Celery&lt;/a&gt; and it is composed mainly by two parts:&lt;/dt&gt;
&lt;dd&gt;&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;the notifications service thats send messages to a queue&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;a pool of workers that fetch messages from the queue and deliver the
notifications&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;To achieve our goal we only had to change the way that notifications service
sends messages to the queue by specifing the low or default priority queue based
on the message type and by running a specific pool of workers bound to each
priority queue.&lt;/p&gt;
&lt;p&gt;Example code with routing:&lt;/p&gt;
&lt;pre class="literal-block"&gt;from celery import Celery

celery = Celery()
celery.main = 'Test app'
celery.config_from_object('celeryconfig')
celery.autodiscover_tasks(
    ['tasks'],
    force=True
)


@celery.task
def task(prio, message):
    print(f'{prio}: {message}')

# calling the task specifying the queue
task.apply_async(args=('default', next(generator)),
                 queue='default')&lt;/pre&gt;
&lt;dl class="simple"&gt;
&lt;dt&gt;How to run a worker specifing the queue::&lt;/dt&gt;
&lt;dd&gt;&lt;p&gt;$ celery -A tasks worker --loglevel=INFO -Q default&lt;/p&gt;
&lt;/dd&gt;
&lt;/dl&gt;
&lt;p&gt;This solution works but there is an efficency problem since when the low
priority queue will be empty the low priority workers will be idle wasting
precious (and paid) resources; fortunately there is a simple solution for this
because it is possible to specify more than one queue using the -Q parameter.
This way we will have a dedicated pool of workers that will work on messages
generated by user activity and a second pool of workers that will handle the
automated messages and, when those will be finished, these workers can help
with default priority messages.&lt;/p&gt;
&lt;p&gt;An example implementation is provided in this &lt;a class="reference external" href="https://github.com/fpischedda/celery-routing-example"&gt;repo&lt;/a&gt; with instruction to run the
different use cases.&lt;/p&gt;
&lt;p&gt;P.S.
&lt;a class="reference external" href="https://www.vimcar.com"&gt;We&lt;/a&gt; are &lt;a class="reference external" href="https://vimcar.de/career/jobs"&gt;hiring&lt;/a&gt;!&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;</description><category>Python Celery Vimcar</category><guid>https://francesco.pischedda.info/posts/routing-celery-task-for-simple-prioritization/</guid><pubDate>Sun, 15 Jul 2018 07:10:22 GMT</pubDate></item><item><title>Evaluating Rust for game development</title><link>https://francesco.pischedda.info/posts/evaluating-rust-for-game-development/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div class="section" id="evaluating-rust-for-game-development"&gt;
&lt;h2&gt;Evaluating Rust for game development&lt;/h2&gt;
&lt;p&gt;There is no doubt that Rust is gaining popularity as a system development
language and most of the time games and game engines are built using languages
such as c or c++ which were born with the same target in mind, being able to
access all the capabilities that a machine has to offer with the minimum
runtime overhead.&lt;/p&gt;
&lt;p&gt;In the last years, powerful engines and tools have offered a pletora of bindings
for different languages like C#, Lua, Python, Javascript and so on with great
results; for example Unity have had and continue to have a great success
providing a powerful platform to build game on so why taking the risk and effort
to use such a low level language to build a game?&lt;/p&gt;
&lt;p&gt;As an "old school" developer I prefer to be in control of my software development
stack and often, instead of creating the game that I have in mind, I start
creating an engine to build my game on...but why?
That's because it is fun! Or because for some simple game it seems to be easier
to create a small library (or extend some old code) instead of using a powerfull
solution like Unreal Engine, or and or and or...&lt;/p&gt;
&lt;p&gt;I have started creating games again and again using high level languages like
Python, Javascript, Lua and even the good old c++; in general I really like to
create prototypes with python but it is not easy to distribute your games and
almost impossible (or reaay hard) to target mobile platforms.
Another option is to target the browser with the growing set of available engines
but again, targeting mobile platforms can be a problem and targeting consoles is
almost impossible.&lt;/p&gt;
&lt;p&gt;Rust on the other end is a very young player in the field but with its
ability to target many architectures I think that starting to think about
using it can be a safe bet; there is at least one success story for using rust
for game development and the final result is &lt;cite&gt;encouraging&amp;lt;https://www.rust-lang.org/pdfs/Rust-Chucklefish-Whitepaper.pdf&amp;gt;&lt;/cite&gt;.&lt;/p&gt;
&lt;div class="section" id="list-of-available-resources"&gt;
&lt;h3&gt;List of available resources&lt;/h3&gt;
&lt;p&gt;Right now the best collection of rust game development related project can be
found in the "Are we game yet" &lt;cite&gt;page&amp;lt;http://arewegameyet.com/&amp;gt;&lt;/cite&gt;.
this web site maintain a list of frameworks and engines fro the lowest level
flavour to the most complete game engine.&lt;/p&gt;
&lt;p&gt;Of all the available solutions &lt;cite&gt;ggez&amp;lt;https://github.com/ggez/ggez/&amp;gt;&lt;/cite&gt; (Good Game Easy)
is the one which attracts me the most because I like to create small prototypes
and not having the knowledge overhead required by other full featured engines or
frameworks like &lt;cite&gt;piston&amp;lt;https://github.com/PistonDevelopers/piston&amp;gt;&lt;/cite&gt; or
&lt;cite&gt;amethyst&amp;lt;https://github.com/amethyst/amethyst&amp;gt;&lt;/cite&gt; it is helpful when experimenting;
it also feels like a microframework to which you can add the components you need
without having to comply with other people choices and taste.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;</description><category>rust gamedev programming</category><guid>https://francesco.pischedda.info/posts/evaluating-rust-for-game-development/</guid><pubDate>Sun, 06 May 2018 16:19:55 GMT</pubDate></item><item><title>Cython and C pointers</title><link>https://francesco.pischedda.info/posts/cython-and-c-pointers/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div&gt;&lt;p&gt;&lt;a class="reference external" href="http://www.cython.org/"&gt;Cython&lt;/a&gt; is a powerful tool that can speed up your &lt;a class="reference external" href="https://www.python.org/"&gt;Python&lt;/a&gt; code or can help you
to quickly create an extension module for a library that has c bindings.&lt;/p&gt;
&lt;p&gt;This post is not a cython tutorial but its about a problem I have encountered
during the development of a wrapper to Wakaama LWM2M library; if you
want to learn more about &lt;a class="reference external" href="http://www.cython.org/"&gt;Cython&lt;/a&gt; please refer to its &lt;a class="reference external" href="https://cython.readthedocs.io/en/latest/"&gt;documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;During the development of said wrapper I have had a nasty strange bug affecting
my code, at some point some object referenced by a pointer kept at the C library
side seemed to change its value! For example think about this situation:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;you pass an object to a certain c function&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;the object's pointer is stored internally by the c library&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;you retrieve the object from the c library but its content its not the same...it's not even an instance of the same class!&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To reproduce this behaviour please have a look at overwrite.py in my test &lt;a class="reference external" href="https://github.com/fpischedda/cython-post"&gt;project&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;At first I've been thinking about memory corruption caused by the C library code;
this wrong assumption costed me at least two days of messing with gdb (that
saved my life in another memory related bug) that have not given any useful
insight.&lt;/p&gt;
&lt;p&gt;I don't remember how I've spotted this problem but probably I should have tryed
everything until something pointed me to the right direction.&lt;/p&gt;
&lt;p&gt;What seems to happen here is something like this:&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;p&gt;create an object and assign it to a variable A&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;store its pointer in the C library&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;get back the pointer of the object; it will be the same object as referenced by A&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;assign a new object to A&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;create an object assign it to a variable B&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;get back the pointer of the object; it will NOT be the same object as
referenced by A but it will be the one referenced by B&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;When the variable A is referencing the new object the old one is not referenced
by anyone in the python world and its memory will became available to store the
new object assigned to B and the pointer in the C world is now pointing to what
is referenced by B.&lt;/p&gt;
&lt;p&gt;It may seems obvious but when it happened to me it was inside a callback
originating in the C code and being handled by a function defined in the
cython context.&lt;/p&gt;
&lt;div class="section" id="lesson-learned"&gt;
&lt;h2&gt;Lesson learned&lt;/h2&gt;
&lt;p&gt;When working with two different languages together
nothing is naive especially when you are wrapping some code that you don't
really know and that can bite your ass as soon as you think "what can go wrong?"&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description><category>python cython c</category><guid>https://francesco.pischedda.info/posts/cython-and-c-pointers/</guid><pubDate>Fri, 06 Jan 2017 15:43:40 GMT</pubDate></item><item><title>The joy of contributing to open source/free software</title><link>https://francesco.pischedda.info/posts/the-joy-of-contributing-to-open-sourcefree-software/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div&gt;&lt;p&gt;From time to time I like to give back to the community with small patches or
trying to solve issues, sometimes my contribution comes from bugs found while
implementing some kind of software and sometimes I just notice something that
can be fixed or improved.&lt;/p&gt;
&lt;p&gt;Usually to process is a kind of cold syntetic handshake between my code and
whatever (D)VCS system used to accept my work but it happens that you will
find some real person at the other side and this is especially true at
Mozilla.&lt;/p&gt;
&lt;p&gt;In my opinion Mozilla infrastructure and people are key factors in welcoming new
developers; there are clear documents about the processes which
you will be pointed to by the team and there are real persons that will help you
until you master the procedure.&lt;/p&gt;
&lt;div class="section" id="which-are-the-take-aways-of-contributing"&gt;
&lt;h2&gt;Which are the take aways of contributing?&lt;/h2&gt;
&lt;p&gt;First of all you are forced to read someone else's code; if you work alone or
your employer does not force code reviews this is really helpful because you
are probably going to learn a lot from other sources.&lt;/p&gt;
&lt;p&gt;Similarly when contributing to other people's code you are forced to add unit
tests to your patches otherwise your code will not be accepted; this is ideal
in the situations where in your day to day work tests are seens as useless
nerd goodies.&lt;/p&gt;
&lt;p&gt;When contributing to bigger projects there is usually a strong procedure that
must be followed; this is not just bureaucracy but it must be seen as a backbone
of the development/deployment/release process. Knowing that any regression
"shall not pass" is a huge boost to your confidence while creating your patch.&lt;/p&gt;
&lt;p&gt;And finally people! I think that is the most amazing part of the work; you'll
get to know persons that will teach you something (or maybe the opposite), you
will have to communicate effectively to make your point or just to understand
what problem you are going to fix, increasing your communication skills; oh and
don't we forget the joy of talking to nice people :)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusions"&gt;
&lt;h2&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;Contributing can be a beautiful and useful experience for beginners,
intermediate and senior developers, everyone can learn something while doing
useful work for the community (which in turn will provide a better tools for
yourself too); even if the amount of free time you have at hand is a couple
of hours a week I suggest trying at least to document some software you use or
fix that annoying bug that is driving you crazy, you will thank yourself!&lt;/p&gt;
&lt;p&gt;P.S.&lt;/p&gt;
&lt;p&gt;I'd like to thank Andrew Halberstadt for his help and his patience while
working on some issues on Mozilla Central repo/bugzilla, thank you Andrew!&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description><category>free software open source mozilla</category><guid>https://francesco.pischedda.info/posts/the-joy-of-contributing-to-open-sourcefree-software/</guid><pubDate>Thu, 29 Dec 2016 14:26:08 GMT</pubDate></item><item><title>cx_Freeze, again</title><link>https://francesco.pischedda.info/posts/cx_freeze_again/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div class="section" id="we-meet-again-xz-freeze"&gt;
&lt;h2&gt;We meet again, xz_Freeze&lt;/h2&gt;
&lt;p&gt;It's been a long time since the last post and for sure I was not thiking about
another post about cx_Freeze.
I have spent this week end trying (and at the end  succeding) to build an
update to an old software. For future memory I'll write briefly the steps needed
to get a functional build without losing my mind.&lt;/p&gt;
&lt;div class="section" id="brief-description-of-the-problem"&gt;
&lt;h3&gt;Brief description of the problem&lt;/h3&gt;
&lt;p&gt;The software is a desktop application used to upload email attachments to a
web based data store; the application talk to the web app using a "RESTy" api,
and fetches the file from a email address; the GUI is written with the beatiful
PyQT5 (someone may prefere PySide) and usually this dependency is a pain to
work with but I have to admit that the newer version installs gracefuly.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="os-version-and-things-to-download"&gt;
&lt;h3&gt;OS version and things to download&lt;/h3&gt;
&lt;p&gt;The person using this software needs to run it from a Windows OS and at this time
Windows 7 is the oldes worsion of the OS I want to support (no Vista, please)
since addressing Windows 10 will produce an executable with no retro compatibily
and Windows 8 have less installs than 7.&lt;/p&gt;
&lt;p&gt;The first software needed to be dowloaded is obviusly the Python 3.5 interpreter
and after its installation came the first surprise, it doesn't run because of
some missing dlls; after some research I have downloaded the redistribuitable
runtime and it started to work as expected.&lt;/p&gt;
&lt;p&gt;After Python was ready I've had to install the pip utility which was not
automatically installed, maybe I have forgotten to chek the corresponding
option in the installer; anyway everything installed correctly using it, this is
a brief list of dependencies:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;requests: OK&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;paramiko: OK&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;imapclient: OK&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;PyQT: (surprisingly!) OK&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;cx_Freeze: Not ok at all..&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;cx_Freeze requires Widonws build tools that can freely (as in beer) downloaded
and installed but even after that I was not able to install it from pip;
fortunately some kind people provided a procompiled wheel for it but be sure
to download the 5.0 version because the 4.x was not able to produce a proper
executable.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="additional-dependencies-and-some-setup-py-notes"&gt;
&lt;h3&gt;Additional dependencies and some setup.py notes&lt;/h3&gt;
&lt;p&gt;Having not touched I tought that the setup script was soemwhat correct since
the last build was succesful, nothing more far from the truth; the first thing
has been a nice surprise, cx_Freeze recognized correctly all the dlls to use in
the final package and referencing additional dlls is not needed anymore, good
work cx_Freeze guys!&lt;/p&gt;
&lt;p&gt;After the first build ihave started a cycle of try, fix retry until the
application could as expected, here is a list of additional dependencis that I
had to install and reference in the setup.py file:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;appdir&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;packaging&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;atexit&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;appdir and atexit only need to be referenced as packages instead packaging
requires some more fine tuining so I had to add this additional sub_packages
to the includes settings of the build_exe_options dictionary:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;packaging.version&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;packaging.specifiers&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;packaging.requirements&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="final-words"&gt;
&lt;h3&gt;Final words&lt;/h3&gt;
&lt;p&gt;It took me a couple of hours of trial/error to be able to ship the build and I
hope to not have to repeat this madness again soon; if I'll need to create a new
build in the future I hope that this little post will halp me not to waste my
time again.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;</description><category>cx_Freeze Python PyQT Windows</category><guid>https://francesco.pischedda.info/posts/cx_freeze_again/</guid><pubDate>Sun, 13 Nov 2016 20:45:17 GMT</pubDate></item><item><title>PyQT5 and cx_Freeze Windows™ target tips</title><link>https://francesco.pischedda.info/posts/pyqt5-and-cx_freeze-windowstm-target-tips/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div&gt;&lt;p&gt;One of my preferred benefits of &lt;a class="reference external" href="http://www.python.org"&gt;Python&lt;/a&gt; is its portability and if coupled
with good libraries such as &lt;a class="reference external" href="http://pyqt.sourceforge.net/Docs/PyQt5/index.html"&gt;PyQT5&lt;/a&gt; the possibilities are endless.&lt;/p&gt;
&lt;p&gt;Now imagine you created a new shiny desktop application and you want to
distribute it, how can you package the app for easy installation?&lt;/p&gt;
&lt;div class="section" id="say-hello-to-cx-freeze"&gt;
&lt;h2&gt;Say hello to &lt;a class="reference external" href="http://cx-freeze.sourceforge.net"&gt;cx_Freeze&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="http://cx-freeze.sourceforge.net"&gt;cx_Freeze&lt;/a&gt; is a tool that can create a standalone version of your application
so you can easily distribute it and the end user don't have to:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;download your source code&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;a python interpreter&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;setup pip or easy_install, libraries and so on&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Another nice feature of &lt;a class="reference external" href="http://cx-freeze.sourceforge.net"&gt;cx_Freeze&lt;/a&gt; is that it can create an installer for many
different operating systems giving your application a more "professional" look.&lt;/p&gt;
&lt;p&gt;I strongly suggest giving it a try; using one of the sample setup scripts
should be enough to get started.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="some-minor-issues"&gt;
&lt;h2&gt;Some minor issues&lt;/h2&gt;
&lt;p&gt;A simple application which only depends on pure python packages usually will
not give you any headaches but if you have dependencies like PyQT5 a bit of
attention is required.
In my case not all the required DLL were included in the installer package and
that generated a strange error message that was very hard to debug but thanks
to sites like &lt;a class="reference external" href="http://www.stackoverflow.com"&gt;StackOverflow&lt;/a&gt; I've found a nice &lt;a class="reference external" href="http://bit.ly/1kvWVAa"&gt;fix&lt;/a&gt; for it.
It is worth noting that linked solution is not (always?) enough but there is a
quick solution (at least in my case): add the file libegl.dll to the
"include_files" &lt;a class="reference external" href="http://cx-freeze.sourceforge.net"&gt;cx_Freeze&lt;/a&gt; building options.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="how-to-test-your-shiny-new-installer"&gt;
&lt;h2&gt;How to test your shiny new installer&lt;/h2&gt;
&lt;p&gt;In order to test your installer and be sure that all the DLLs are incuded and
your application is not "cheating" on you using system DLLs I suggest to create
a clean windows installation inside a virtual machine; this way you can test
your installer in a real case scenario and fix your build scripts accordingly.&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</description><category>python pyqt5 cx_freeze packaging windows</category><guid>https://francesco.pischedda.info/posts/pyqt5-and-cx_freeze-windowstm-target-tips/</guid><pubDate>Fri, 02 May 2014 11:04:54 GMT</pubDate></item><item><title>Logging model changes with SQLAlchemy listeners</title><link>https://francesco.pischedda.info/posts/logging-model-changes-with-sqlalchemy-listeners/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div class="section" id="logging-modela-changes-with-sqlalchemy-listeners"&gt;
&lt;h2&gt;Logging modela changes with SQLAlchemy listeners&lt;/h2&gt;
&lt;div class="section" id="scenario"&gt;
&lt;h3&gt;Scenario&lt;/h3&gt;
&lt;p&gt;Imagine you have a slew of models in your application, at some point you feel
the need to log somewhere creation, modification or deletion of data belonging
to these models.
How to proceed without having to modify the classes one by one?&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="what-s-on-sqlalchemy"&gt;
&lt;h3&gt;What's on sqlalchemy&lt;/h3&gt;
&lt;p&gt;SQLAlchemy (&lt;a class="reference external" href="http://sqlalchemy.org"&gt;http://sqlalchemy.org&lt;/a&gt;) offers a couple of interesting mechanisms:
the first concerns the possibility to hook to some event listeners such as
before_insert, before_update, before_delete and the corresponding after_*.
Additional help is provided by sqlalchemy the opportunity to work on a model
after its definition by overriding the method __declare_last__.
Using these facts, and assuming that you have defined a model named MyModel,
if we wanted to intercept the event "after_insert" we could write the following
code:&lt;/p&gt;
&lt;pre class="code python"&gt;&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MyModel&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-2"&gt;&lt;/a&gt;&lt;span class="c1"&gt;#lets pretend to have defined our model&lt;/span&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-3"&gt;&lt;/a&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-4"&gt;&lt;/a&gt;  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;after_insert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mapper&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-5"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;#do some stuff&lt;/span&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-6"&gt;&lt;/a&gt;    &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-7"&gt;&lt;/a&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-8"&gt;&lt;/a&gt;  &lt;span class="nd"&gt;@classmethod&lt;/span&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-9"&gt;&lt;/a&gt;  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__declare_last__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_62874f6cefc8442c9920518bada0095e-10"&gt;&lt;/a&gt;    &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"after_insert"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;after_insert&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;Whenever an object of class MyModel will be entered into the database
after_insert method will be called , passing as parameters the mapping of the
model, the connection and the target is none other than the object that has
just been entered into the database.&lt;/p&gt;
&lt;p&gt;In the event that you are intercepting the creation or deletion of an object
is sufficient to access its primary key to identify it in your log, but if we
wanted to know which fields have been modified, with new and old values, as a
result of an update it gets a little more complicated, but not too much.
In fact sqlalchemy allows us, quite easily , to check the status of the fields
of an object using the function sqlalchemy.orm.attributes.get_history (&lt;a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/session.html#sqlalchemy.orm.attributes.get_history"&gt;http://docs.sqlalchemy.org/en/latest/orm/session.html#sqlalchemy.orm.attributes.get_history&lt;/a&gt;).
This function is called for each field, it returns an object of type History (&lt;a class="reference external" href="http://docs.sqlalchemy.org/en/latest/orm/session.html#sqlalchemy.orm.attributes.History"&gt;http://docs.sqlalchemy.org/en/latest/orm/session.html#sqlalchemy.orm.attributes.History&lt;/a&gt;)
which we will use the method has_changes() to check for changes, and if there were,
getting the new and old values of the field that we are analyzing, for example:&lt;/p&gt;
&lt;pre class="code python"&gt;&lt;a name="rest_code_18efc29c5f714ac3adc1a9fad1086f30-1"&gt;&lt;/a&gt;&lt;span class="n"&gt;h&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_history&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"a_field"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a name="rest_code_18efc29c5f714ac3adc1a9fad1086f30-2"&gt;&lt;/a&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;h&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;has_changes&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;a name="rest_code_18efc29c5f714ac3adc1a9fad1086f30-3"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;#do something using h.deleted list to get the old values&lt;/span&gt;
&lt;a name="rest_code_18efc29c5f714ac3adc1a9fad1086f30-4"&gt;&lt;/a&gt;  &lt;span class="c1"&gt;#do something using h.added list to get the new values&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="loggablemixin"&gt;
&lt;h3&gt;LoggableMixin&lt;/h3&gt;
&lt;p&gt;Clearly to do this for all models of an application may be costly in terms of
time and code maintenance (and extremely annoying) so you might think about
creating a generic Mixin with which to extend the models of our application.
Below is the skeleton for the implementation of the above mixin, omitting the
details of where and how the logs are stored:&lt;/p&gt;
&lt;pre class="code python"&gt;&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;LoggableMixin&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-2"&gt;&lt;/a&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-3"&gt;&lt;/a&gt;  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;after_insert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mapper&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-4"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;#do some stuff for the insert&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-5"&gt;&lt;/a&gt;    &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-6"&gt;&lt;/a&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-7"&gt;&lt;/a&gt;  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;after_update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mapper&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-8"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;#do some stuff for the update, maybe saving the changed fields values using get_history&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-9"&gt;&lt;/a&gt;    &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-10"&gt;&lt;/a&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-11"&gt;&lt;/a&gt;  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;after_delete&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mapper&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-12"&gt;&lt;/a&gt;    &lt;span class="c1"&gt;#do some stuff&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-13"&gt;&lt;/a&gt;    &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-14"&gt;&lt;/a&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-15"&gt;&lt;/a&gt;  &lt;span class="nd"&gt;@classmethod&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-16"&gt;&lt;/a&gt;  &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;__declare_last__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-17"&gt;&lt;/a&gt;    &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"after_insert"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;after_insert&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-18"&gt;&lt;/a&gt;    &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"after_update"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;after_update&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;a name="rest_code_35d319a097a64798835c8c3e86b7bd7a-19"&gt;&lt;/a&gt;    &lt;span class="n"&gt;event&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;listen&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;cos&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"after_delete"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;after_delete&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;p&gt;so, for each model we want to log changes it will be sufficient to inherit from LoggableMixin:&lt;/p&gt;
&lt;pre class="code python"&gt;&lt;a name="rest_code_2490dce6ab7646bfb0d392c4cfd38ce5-1"&gt;&lt;/a&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;MyModel&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;SomeSuperClass&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;LoggableMixin&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;a name="rest_code_2490dce6ab7646bfb0d392c4cfd38ce5-2"&gt;&lt;/a&gt;  &lt;span class="k"&gt;pass&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="improvements"&gt;
&lt;h3&gt;Improvements&lt;/h3&gt;
&lt;p&gt;One of the first improvements you can make to the class LoggableMixin could be
the separation of the class in three different classes eg . LogInsertMixin, LogUpdateMixin LogDeleteMixin,
in my case I preferred to have it all together given the small size of the class.
A second improvement would be the generalization of mixin allowing you to
specify which functions (or methods) to be assigned to different listeners,
and once more the specific needs of the application I'm working on does not
require this level of abstraction and can live well with this approach.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="conclusions"&gt;
&lt;h3&gt;Conclusions&lt;/h3&gt;
&lt;p&gt;SQLAlchemy provides a number of services to work with the model, the system
just described would not have been so easy to implement if it were not for the
quality of the API of sqlalchemy.
I invite anyone to go deeper in the documentation for sqlalchemy (&lt;a class="reference external" href="http://docs.sqlalchemy.org"&gt;http://docs.sqlalchemy.org&lt;/a&gt;)
because within it are preserved gems of great value.
For those wishing to see a concrete implementation of the topics discussed in
this post they can take a look at the file sysgrove/models.py in the repository
at &lt;a class="reference external" href="https://bitbucket.org/sysgrove/sysgrove"&gt;https://bitbucket.org/sysgrove/sysgrove&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;</description><category>python sqlalchemy</category><guid>https://francesco.pischedda.info/posts/logging-model-changes-with-sqlalchemy-listeners/</guid><pubDate>Wed, 11 Dec 2013 14:33:03 GMT</pubDate></item><item><title>Our QT date picker</title><link>https://francesco.pischedda.info/posts/our-qt-date-picker/</link><dc:creator>Francesco "fpsd" Pischedda</dc:creator><description>&lt;div class="section" id="our-qt-date-picker"&gt;
&lt;h2&gt;Our QT date picker&lt;/h2&gt;
&lt;p&gt;One of the first works carried out just entering at SysGrove (&lt;a class="reference external" href="http://sysgrove.com"&gt;http://sysgrove.com&lt;/a&gt; )
consisted in rewriting the date picker component in our application and
requests regarding this component was that it was similar, at least as a
feature, to the date picker available in windows 7 ™. The most interesting
aspect of this component is the ability to be able to do some sort of zoom
dates, I try to explain with an example:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;p&gt;It would be a classic date picker where are the days of the current month and
the ability to change the month with the classic arrows&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Clicking on the button in the middle of the arrows the days are replaced by
months and the arrows will change the current year&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Again by clicking on the button in the middle of the arrows months will be
replaced by the years and the arrows will change the decade&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Selecting a year will return a month view and by selecting a month will
return a day view&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Some images could help to understand the behaviour:&lt;/p&gt;
&lt;div class="figure"&gt;
&lt;img alt="day selector" src="https://francesco.pischedda.info/images/qt-calendar/date-picker-day.png"&gt;
&lt;p class="caption"&gt;The day selector, with month changer arrows; if you click the middle button
you'll see the month selector.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="figure"&gt;
&lt;img alt="/images/qt-calendar/date-picker-month.png" src="https://francesco.pischedda.info/images/qt-calendar/date-picker-month.png"&gt;
&lt;p class="caption"&gt;The month selector, if you click on the middle button you'll see the year
selector.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="figure"&gt;
&lt;img alt="/images/qt-calendar/date-picker-year.png" src="https://francesco.pischedda.info/images/qt-calendar/date-picker-year.png"&gt;
&lt;p class="caption"&gt;The selector selector.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Fortunately SysGrove is a company that believes strongly in open source and
sharing so I got permission to release this as open source project component,
nice! :)&lt;/p&gt;
&lt;p&gt;At present the appearance of the component is not that great and you have to
put hand to customize the code of the component , in the future I hope to be
able to allow the customization of the graphical component directly in the
process of creating an instance rather than in its base code.&lt;/p&gt;
&lt;p&gt;The source of this component for the moment can be found in the main repository
of our application ( &lt;a class="reference external" href="https://bitbucket.org/sysgrove/sysgrove"&gt;https://bitbucket.org/sysgrove/sysgrove&lt;/a&gt; ) path sysgrove /
ui / classes / widgets / calendar.py&lt;/p&gt;
&lt;/div&gt;</description><category>pyqt python datepicker</category><guid>https://francesco.pischedda.info/posts/our-qt-date-picker/</guid><pubDate>Tue, 10 Dec 2013 20:52:42 GMT</pubDate></item></channel></rss>